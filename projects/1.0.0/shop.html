<link rel="stylesheet" type="text/css" href="css/shop.css">
<div class="header_title">
  <!-- <input type="text" class="shopSearch" placeholder="搜索商品"/> -->
  <p>小店铺</p>
  <div class="myOrder-enter" onclick="winGo('/shop/shop-order.html')"></div>
</div>
<div class="shop pt1">
	<div class="shop-list">
		<!-- <div class="shop-item">
			<a href="">
				<div class="shop-img">
					<img src="images/product-img.jpg" alt="">
				</div>
				<div class="shop-right">
					<div class="shop-name">皇后的新装</div>
					<div class="shop-d">店铺简介</div>
					<div class="shop-bottom">
						<div class="shop-min">评分4.9</div>
						<div class="shop-pei">20元起送</div>
						<div class="shop-map">广东农工商</div>
					</div>
				</div>
			</a>
		</div> -->
	</div>
</div>
<script>
 tab = "shop";
  loading(true); //动画
  getShopList();
  var app = 0;
  if(GetString("device") == "android"){
  	$("footer").remove();
  	app =1;
    window.localStorage.app=1;
  }
  function getShopList(a) {
        if (!getItemATime("shop") && a != 1) {
            var loca = getItem("shop");
            var htmldom = loca[0];
            $(".shop-list").html(htmldom);
            loading(false); 
          }else{
            getShopCon()
          };
      }
  function getShopCon(page) {
        var page = page == undefined ? 1 : page;
        if($("#loading").length == 0 && page!=1){
    			$(".shop").append("<div id='loading'>正在玩命的加载中...</div>");
    		}
        var getData = {
          "page" : page 
        }
        if(app){
          var token = window.localStorage.token;
          if(token != undefined){
            getData["token"] = token;
          }
        }else{
          if( window.localStorage.token != undefined){
            var token = window.localStorage.token;
            getData["token"] = token;
          }
        }
        $.getJSON(locahost + "/shop/shops/",getData,
        function(data) {
          loading(false);
          if (data.code == 200) {
              clearLoading();
              var htmldom='';
              $.each(data.shops,function(a,b){
                if(b.shop_status == 1){
                  var shop_status = ""
                }else if(b.shop_status == 3){
                  var shop_status = "<span class='rest'>(打烊中)</span>"
                }

                var cart_countHtml =""
                if(b.cart_count != undefined && b.cart_count !=  0 && b.shop_status != 3){
                  //没有购物车
                  cart_countHtml = "<span class='cart_count'>"+b.cart_count+"</span>"
                }

                htmldom += '<div class="shop-item opa_active">\
								<a onclick="winGo(\'shop/shop-detail.html?sid='+b.shop_id+'\')">\
									<div class="shop-img" style="background:url('+b.shop_img+') no-repeat center;background-size:cover;">\
                    '+cart_countHtml+'\
									</div>\
									<div class="shop-right">\
										<div class="shop-name">'+b.shop_name+shop_status+'</div>\
										<div class="shop-d">'+b.description+'</div>\
										<div class="shop-bottom">\
											<div class="shop-pei">'+b.shipping_fee+'元起送</div>\
											<div class="shop-map">'+b.address+'</div>\
										</div>\
									</div>\
								</a>\
							</div>';
              })
               if(page != 1){
                  $('.shop-list').append(htmldom);
                  if(data.shops.length < 10 && $("#loaded").length == 0){
                     $(".shop").append('<div id="loaded" >我是有底线的</div>')
                  }
                }else{
                  if(data.shops.length == 0){
                    $(".noShop").show();
                    $(".shop-list").hide();
                  }else{
                    console.log(1)
                    $('.shop-list').html(htmldom);
                    setItem("shop",htmldom);
                    if( $("#loaded").length == 0){
                      $(".shop").append('<div id="loaded" >我是有底线的</div>')
                    }
                   
                  }
                }
              
              if ( data.shops.length == 10) {
                 $(window).on("scroll",function(){
                  if($(window).scrollTop()+50>=$(document).height()-$(window).height()){
                    //到底
                    page++;
                    getShopCon(page);
                  }
                 })
              }
            }        
        });
      }
      //打开搜索页面
      $(".shopSearch").focus(function(){
        winGo("shop/shop-search.html");
      })
  refresh["shop"]= getShopList;    
</script>


