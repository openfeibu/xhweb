<!DOCTYPE html>
<html lang="en" style="background:none">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta content="telephone=no" name="format-detection" />
  <!-- uc强制竖屏 -->
  <meta name="screen-orientation" content="portrait">
  <!-- UC应用模式 --> 
  <meta name="browsermode" content="application">
  <!-- QQ强制竖屏 -->
  <meta name="x5-orientation" content="portrait">
  <!-- QQ应用模式 -->
  <meta name="x5-page-mode" content="app">
  <!-- UC禁止放大字体 -->
  <meta name="wap-font-scale" content="no">
  <title>校汇Plus | 校汇 </title>
  <meta name="Keywords" content="校汇,广东农工商职业技术学院,AIB,农工商,能赚钱,大学生,大学生创业,大学生校园,大学生校园社团,大学生校园快递,大学生周边生活" />
  <meta name="Description" content="校汇是一个以校园任务为核心的移动互联网综合服务平台，立足于校园，致力打造完整的校园生态辐射圈。校汇一直专注于大学生活、社团文化、校园资讯、学生互动" />
  <link rel="apple-touch-icon-precomposed" href="./icon.png" />
  <link rel="shortcut icon" href="./icon.png" type="image/x-icon">
  <link rel="stylesheet" type="text/css" href="../css/reset.css">
  <link rel="stylesheet" type="text/css" href="../css/index.css">
  <link rel="stylesheet" type="text/css" href="../css/info.css">
  <link href="../css/swiper.min.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="../js/common.js"></script>
  <script type="text/javascript" src="../js/director.js"></script>
  <script type="text/javascript" src="../js/updata.js"></script>
  <script type="text/javascript" src="../js/md5.js"></script>
  <script src="../js/swiper.min.js"></script>
</head>
<body class='bgf'>
<section class='main' style="padding-bottom:0">
     <div class="header_title">
            <p>校园任务详情</p>
            <div class="return" onclick="returnUp()">
            </div>
        </div>
        <div class="schoolwork_de schoolwork_de pt1">
          <div class="schoolwork_info">
          </div>
          <div class="works-report"><i class="works-report-icon"></i><p><a href="">举报</a></p></div>
          <div class="works-declare">注：用户每完成一次任务后，平台会收取赏金总额的2%作为平
台服务费，更多详情请查看<a href="../statement/workAgreement.html">任务声明</a></div>
          <div class="postwork_footer">
            <div class="postwork_button"></div>
          </div>
        </div>
</section>
    <!-- 支付界面 -->
      <div class="walletPass orderWalletPass" >

          <div class="payPassVal">  
              <div class="payPass_close">X</div>
              <div class="payPassVal_title">请输入钱包支付密码</div>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
          </div>
          <ul class="payNum">
              <li>1</li>
              <li>2</li>
              <li>3</li>
              <li>4</li>
              <li>5</li>
              <li>6</li>
              <li>7</li>
              <li>8</li>
              <li>9</li>
              <li></li>
              <li>0</li>
              <li>删除</li>
          </ul>
      </div>
</body>
<script>
    /*获取参数*/
    var oid = GetString("oid");
    var token = window.localStorage.token;
    loading(true);
    $(".main ").css("minHeight",$(window).height());
    $.getJSON(locahost+'/order/getOrderByToken/?token='+token+'&order_id='+oid,function(data){
             loading(false); 
             var b = data.data;
             var owner_id = b.owner_id; //发单人ID
             var courier_id = b.courier_id; //接单人ID
             var mine_id = window.localStorage.uid; //我的D

             if(owner_id == mine_id){
              //我发的单
              if(b.status == "new"){
                 var input_submit ='<input style="width:100%" type="button" value="取消任务" class="closeOrder opa_active"/>';
              }else if(b.status == "finish"){
                var input_submit = '<input style="width:100%" type="button" value="结算任务" class="completedOrder"/>'
              }else {
                var input_submit = ''

              }
             
              // var tell = '<div class="tell"><a href="tel:">联系TA</a></div>';
              var tell = '';
              var workType = "发单人";
                /*时间进程 S*/ 
                if(b.time['cancelled_time']){
                //取消的订单 
                 }else{
                  //非取消的订单
                    if(b.time['completed_time']){
                      //已结算
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>完成</label>\
                                        <p>'+b.time['finish_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>结算</label>\
                                        <p>'+b.time['completed_time']+'</p>\
                                      </li>\
                                  </ul>';
                    }else if(b.time['finish_time']){
                      //已完成
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>完成</label>\
                                        <p>'+b.time['finish_time']+'</p>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }else if(b.time['accepted_time']){
                      //已接单
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li >\
                                        <label>完成</label>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }else{
                      //未接单
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li>\
                                        <label>接单</label>\
                                      </li>\
                                      <li >\
                                        <label>完成</label>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }
                 }
                /*时间进程 E*/ 
             }else if(mine_id != owner_id && courier_id==0){
                //别人发的未接单
                 var input_submit = '<input style="width:100%"  type="button" value="接受任务" class="work_submit opa_active"/>';
                // var tell = '<div class="tell"><a href="tel:">联系TA</a></div>';
                var tell = '';
                var workType = "发单人";
                var state = '';
             }else if(mine_id == courier_id ){
                 //我接的单
                if(b.status == "accepted"){
                  var input_submit = '<input type="button" style="width:50%" value="确认送达" class="DoneOrder opa_active"/><input style="width:50%" type="button" value="取消任务" class="closeOrder opa_active"/>';
                }else{
                   var input_submit = "";
                }
                 
                // var tell = '<div class="tell"><a href="tel:">联系TA</a></div>';
                var tell = '';
                var workType = "接单人";
                 /*时间进程 S*/
               if(b.time['cancelled_time']){
                //取消的订单
                 
                 }else{
                  //非取消的订单
                    if(b.time['completed_time']){
                      //已结算
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>完成</label>\
                                        <p>'+b.time['finish_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>结算</label>\
                                        <p>'+b.time['completed_time']+'</p>\
                                      </li>\
                                  </ul>';
                    }else if(b.time['finish_time']){
                      //已完成
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>完成</label>\
                                        <p>'+b.time['finish_time']+'</p>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }else if(b.time['accepted_time']){
                      //已接单
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li class="on">\
                                        <label>接单</label>\
                                        <p>'+b.time['accepted_time']+'</p>\
                                      </li>\
                                      <li >\
                                        <label>完成</label>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }else{
                      //未接单
                       var state = '<ul class="schedule clearfix">\
                                      <li class="on">\
                                        <label>发单</label>\
                                        <p>'+b.time['new_time']+'</p>\
                                      </li>\
                                      <li>\
                                        <label>接单</label>\
                                      </li>\
                                      <li >\
                                        <label>完成</label>\
                                      </li>\
                                      <li >\
                                        <label>结算</label>\
                                      </li>\
                                  </ul>';
                    }
                 }
                /*时间进程 E*/ 
             }
             var bg = b["order_status"] == "可接单" ? "#87cbf6" :  b["order_status"] == "已接单" ? "#80b995" : "#bbbbbb";
             var workHtml = '<div class="works-state"><p style="background:'+bg+'">'+b.order_status+'</p></div>\
                              <div class="namedata clear">\
                              <div class="name fl">\
                                <div class="img" style="background:#fafafa url('+b.avatar_url+') no-repeat left center/0.7rem 0.7rem;width:0.7rem;height:0.7rem"></div>\
                                <p >'+b.nickname+'<span>('+workType+')</span></p>\
                              </div>'+tell+
                            '</div>\
                            <div class="money">赏金：<span>￥'+b.fee+'元</span></div>\
                            <div class="donemap">到达地点：'+b.destination+'</div>\
                            <div class="detail">'+b.description+'</div>\
                            '+state;
                  // var input_submit = '<input type="button" value="接受任务" class="work_submit"/>';
                  $(".schoolwork_info").html(workHtml);
                  $(".postwork_button").html(input_submit)
  })
    $(".schoolwork_de").on("click",".work_submit",function(){
      alert_flag("确定接受此任务？");
      $(".flag_true").on("click",workSubmit);
    })
    //接受任务
    function workSubmit(){
        $(".flag_A").remove();
        if(window.localStorage.token == undefined || window.localStorage.token == "undefined"){
          fb_alert(fb_error["2001"]);
        window.location.href="login.html";
          return;
        }
        if(!is_auth()){
        fb_alert(fb_error["12"]);
        return;
        }
        $(this).addClass("on");
        var token = window.localStorage.token;
        is_alipay(true);
      $.post(locahost+'/order/claimOrder/?token='+token+'&order_id='+oid,function(data){
        is_alipay(false);
        if(data.code == 2001){
          fb_alert(fb_error["2001"]);
          window.location.href="login.html";
        }
        if(data.code == 2011){
          fb_alert(fb_error["2011"]);
          setTimeout(function(){
            history.go(-1);
            return;
          },500)
          
        }else if(data.code == 110){
          fb_alert(fb_error["110"]);
        }else if(data.code == 200){
          fb_alert(fb_error["2"]);
          window.location.href="../html/order.html";
        }

      })
    }
     //完成任务
      $("body").on("click",".DoneOrder",function(){
        $.post(locahost+'/order/finishWork/?token='+token+'&order_id='+oid,function(data){
          if(data.code == 2001){
            fb_alert(fb_error["2001"]);
            window.location.href="login.html";
          }
          if(data.code == 200){
            fb_alert(fb_error["3001"]);
            history.go(-1)
          }
        })
      })
      //取消任务
      $("body").on("click",".closeOrder",function(){
          alert_flag("是否删除该任务?");
          $(".flag_true").on("click",function(){
            $(".flag_A").remove();
            is_alipay(true);
            $.post(locahost+'/order/askCancel/?token='+token+'&order_id='+oid,function(data){
                is_alipay(false);
                if(data.code == 2001){
                  fb_alert(fb_error["2001"]);
                  window.localStorage.removeItem("faloca");
                  window.location.href="login.html";
                }
                if(data.code == 200){
                  fb_alert(fb_error["3003"]);
                  history.go(-1)
                }
              })
            
          })

      })
       //结算任务
       $("body").on("click",".completedOrder",function(){
        wallet_pass='';
        $(".payPassVal span").text("");
        $(".walletPass").fadeIn(200);
      })
       var wallet_pass='';
     $('.walletPass').on("click",".payNum li",function(){
                var i = $(this).index(".payNum li");
                var key;
                switch (i) {
                    case 0 : 
                        key = 1;
                        break;
                    case 1 : 
                        key = 2;
                        break;
                    case 2 : 
                        key = 3;
                        break;
                    case 3 : 
                        key = 4;
                        break;
                    case 4 : 
                        key = 5;
                        break;
                    case 5 : 
                        key = 6;
                        break;
                    case 6 : 
                        key = 7;
                        break;
                    case 7 : 
                        key = 8;
                        break;
                    case 8 : 
                        key = 9;
                        break;
                    case 9 : 
                        return;
                    case 10 : 
                        key = 0;
                        break;
                    case 11 : 
                        key = 11;
                        break;
                }
            if(key == 11){
                //删除键
                wallet_pass = wallet_pass.substr(0,wallet_pass.length-1);
                $(".payPassVal span").text("")
                for(var j = 0,c=wallet_pass.length ; j <c;j++ ){
                    $(".payPassVal span").eq(j).text("*")
                }
                return;
            }
            wallet_pass += key;
            if(wallet_pass.length == 6 ){
                //满6位 
                  $(".payPassVal span").text("*");
                  is_alipay(true)
                  $(".walletPass").fadeOut(200);
                   $.post(locahost+'/order/confirmFinishWork/?token='+token+'&order_id='+oid+'&pay_password='+$.md5(wallet_pass),function(data){
                    if(data.code == 2001){
                      fb_alert(fb_error["2001"]);
                      window.location.href="login.html";
                    }
                    if(data.code == 200){
                      fb_alert(fb_error["3002"]);
                      history.go(-1)
                    }else{
                      fb_alert(data.detail);

                    }
                    is_alipay(false)
                    $(".schoolwork_de .postwork_footer .postwork_button input").removeClass("on")
                  })

              }else{
                for(var j = 0,c=wallet_pass.length ; j <c;j++ ){
                    $(".payPassVal span").eq(j).text("*")
                }
            }

          })
     $(".payPass_close").on("click",function(){
        $('.walletPass').fadeOut(200);
        $(".completedOrder").removeClass("on")
     })
 </script>
</html>
